<!-- plot-->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script type="text/javascript">
  function onStart() {
    // This function is an accurate interval function
    function AdjustingInterval(workFunc, interval, errorFunc) {
      var that = this;
      var expected, timeout;
      this.interval = interval;

      this.start = function () {
        expected = Date.now() + this.interval;
        timeout = setTimeout(step, this.interval);
      };

      this.stop = function () {
        clearTimeout(timeout);
      };

      function step() {
        var drift = Date.now() - expected;
        if (drift > that.interval) {
          // You could have some default stuff here too...
          if (errorFunc) errorFunc();
        }
        workFunc();
        expected += that.interval;
        timeout = setTimeout(step, Math.max(0, that.interval - drift));
      }
    }
    var ticker = null;
    $("#stopBtn").click(function () {
      console.log("stop");
      if (ticker != null) {
        ticker.stop();
      }
    });
    console.log("Plot Ready ");
    var ctx = document.getElementById("livePlot").getContext("2d");

    var data = {
      labels: [...Array(500).keys()],
      datasets: [
        {
          label: "Data",
          fillColor: "rgba(220,220,220,0.2)",
          strokeColor: "rgba(220,220,220,1)",
          pointRadius: 0,
          borderWidth: 3,
          //backgroundColor: "black",
          borderCapStyle: "butt",
          data: new Array(500).fill(0),
        },
      ],
    };
    var options = {
      animation: false,
      elements: {
        line: {
          tension: 0, // disables bezier curves
        },
      },

      //Boolean - If we want to override with a hard coded scale
      scaleOverride: true,
      //** Required if scaleOverride is true **
      //Number - The number of steps in a hard coded scale
      scaleSteps: 5,
      //Number - The value jump in the hard coded scale
      scaleStepWidth: 20,
      //Number - The scale starting value
      scaleStartValue: 0,
    };

    var myLineChart = new Chart(ctx, { type: "line", data, options });

    if ($("#input-type-live").is(":checked")) {
      setInterval(async function () {
        fetch("http://127.0.0.1:5000/readarr")
          .then((response) => response.json())
          .then((result) => {
            myLineChart.data.datasets.forEach((dataset) => {
              dataset.data.shift();
              dataset.data.push(result);
            });
            myLineChart.update();
          });
      }, 100);
    } else if ($("#input-type-file").is(":checked")) {
      var frame = 0;
      var FRAME_SIZE = 100;
      const file = $("#file-select option:selected").text();
      fetch("http://127.0.0.1:5000/readcsv/" + file)
        .then((response) => response.json())
        .then((result) => {
          console.log("R");
          var startTime = performance.now();
          function doWork() {
            myLineChart.data.datasets.forEach((dataset) => {
              dataset.data.splice(0, 100);
              const newData = result.splice(
                frame * FRAME_SIZE,
                (frame + 1) * FRAME_SIZE
              );
              dataset.data = dataset.data.concat(newData);
            });
            myLineChart.update();
            frame++;
            const endTime = performance.now();
            console.log(endTime - startTime);
          }
          ticker = new AdjustingInterval(doWork, 100);
          ticker.start();
        });
    }

    function setData(data, newVal) {
      data.push(newVal);
      data.shift();
    }

    //Array of values from start to end
    function range(start, end) {
      return Array(end - start + 1)
        .fill()
        .map((_, idx) => start + idx);
    }

    function setLabels(labels) {
      var nextLabel = labels[labels.length - 1];
      labels.splice(0, 100);
      labels = labels.concat(range(nextLabel + 1, nextLabel + 100));
      return labels;
    }
  }
  $(document).ready(function () {
    console.log("Plot Ready ");
    var ctx = document.getElementById("livePlot").getContext("2d");
    var data = {
      labels: [],
      datasets: [],
    };
    var options = {
      animation: false,
    };

    var myLineChart = new Chart(ctx, { type: "line", data, options });
  });
</script>
<!--end polot-->

<canvas id="livePlot" width="200" height="200"></canvas>
