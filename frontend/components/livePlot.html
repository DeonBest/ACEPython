<script type="text/javascript">
  var csvdata = [];
  var featuredata = [];
  var options = {
    series: [
      {
        data: csvdata.slice(),
      },
    ],
    chart: {
      id: "realtime",
      height: 450,
      type: "line",
      animations: {
        enabled: false,
      },
      toolbar: {
        show: false,
      },
      zoom: {
        enabled: false,
      },
    },
    dataLabels: {
      enabled: false,
    },
    stroke: {
      curve: "smooth",
      width: "1",
    },
    markers: {
      size: 0,
    },
    xaxis: {
      type: "numeric",
      labels: {
        show: false,
        //hideOverlappingLabels: true,
      },
      tickAmount: "200",
    },
    yaxis: {
      max: 0.2,
      min: -0.2,
      labels: {
        formatter: (val) => {
          return val.toFixed(2);
        },
      },
      axisBorder: {
        show: true,
        color: "#78909C",
        offsetX: 0,
        offsetY: 0,
      },
      axisTicks: {
        show: true,
        borderType: "solid",
        color: "#78909C",
        width: 6,
        offsetX: 0,
        offsetY: 0,
      },
    },
    grid: {
      show: true,
      borderColor: "black",
      borderWidth: 1,
      position: "front",
      yaxis: {
        lines: {
          show: true,
        },
      },
      xaxis: {
        lines: {
          show: true,
        },
      },
    },
    legend: {
      show: false,
    },
  };
  var chart = new ApexCharts(document.querySelector("#liveChart"), options);

  function onStart() {
    // This function is an accurate interval function
    function AdjustingInterval(workFunc, interval, errorFunc) {
      var that = this;
      var expected, timeout;
      this.interval = interval;

      this.start = function () {
        expected = Date.now() + this.interval;
        timeout = setTimeout(step, this.interval);
      };

      this.stop = function () {
        clearTimeout(timeout);
      };

      function step() {
        var drift = Date.now() - expected;
        if (drift > that.interval) {
          // You could have some default stuff here too...
          if (errorFunc) errorFunc();
        }
        workFunc();
        expected += that.interval;
        timeout = setTimeout(step, Math.max(0, that.interval - drift));
      }
    }

    var ticker = null;
    $("#stopBtn").click(function () {
      if (ticker != null) {
        ticker.stop();
      }
    });

    if ($("#input-type-live").is(":checked")) {
      setInterval(async function () {
        fetch("http://127.0.0.1:5000/readarr")
          .then((response) => response.json())
          .then((result) => {
            myLineChart.data.datasets.forEach((dataset) => {
              dataset.data.shift();
              dataset.data.push(result);
            });
            myLineChart.update();
          });
      }, 100);
    } else if ($("#input-type-file").is(":checked")) {
      var frame = 0;
      var FRAME_SIZE = 100;
      var ms = 0;
      const file = $("#file-select option:selected").text();
      fetch("http://127.0.0.1:5000/readcsv/" + file)
        .then((response) => response.json())
        .then((result) => {
          var startTime = performance.now();
          function doWork() {
            if (csvdata.length > 400) {
              csvdata.splice(0, FRAME_SIZE);
            }
            if (frame % 10 == 0) {
              onNewFeatureData(featuredata);
              featuredata = [];
            }
            const newData = result.splice(0, FRAME_SIZE);
            /*  const newDataFormatted = newData.map((d, i) => {
              //if (frame * FRAME_SIZE > 1000) csvdata.shift();
              csvdata.push({ x: i + frame * FRAME_SIZE, y: d });
            }); */
            csvdata = csvdata.concat(newData);
            featuredata = featuredata.concat(newData);
            chart.updateSeries([
              {
                data: csvdata,
              },
            ]);
            frame++;
            console.log(frame);
          }
          ticker = new AdjustingInterval(doWork, FRAME_SIZE);
          ticker.start();
        });
    }
  }
  $(document).ready(function () {
    chart.render();
  });
</script>
<!--end polot-->

<div id="liveChart" width="200" height="200" backgroundColor="red"></div>
